<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KonfiLog</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#3b82f6; --good:#10b981; --warn:#f59e0b; --bad:#ef4444; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,sans-serif;background:linear-gradient(180deg,#0b1220,#0f172a 35%,#0f172a 100%);color:var(--text)}
    a{color:var(--accent);text-decoration:none}
    .container{max-width:980px;margin:0 auto;padding:16px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:40px;height:40px;border-radius:12px;background:radial-gradient(circle at 30% 30%, #60a5fa, #1e3a8a);display:grid;place-items:center;color:white;font-weight:700}
    .title{font-size:18px;font-weight:700}
    .card{background:rgba(17,24,39,0.6);backdrop-filter:saturate(140%) blur(6px);border:1px solid rgba(148,163,184,0.15);border-radius:16px;padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:900px){.grid{grid-template-columns:1.1fr 0.9fr}}
    input,select,button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(148,163,184,0.25);background:#0b1220;color:var(--text)}
    input::placeholder{color:#94a3b8}
    button{background:linear-gradient(180deg,#2563eb,#1d4ed8);border:none;font-weight:600;cursor:pointer}
    button.secondary{background:#0b1220;border:1px solid rgba(148,163,184,0.25)}
    button.good{background:linear-gradient(180deg,#10b981,#059669)}
    button.warn{background:linear-gradient(180deg,#f59e0b,#d97706)}
    .row{display:flex;gap:12px}
    .row>*{flex:1}
    .muted{color:var(--muted);font-size:14px}
    .hidden{display:none}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#0b1220;border:1px solid rgba(148,163,184,0.25);padding:6px 10px;border-radius:999px;font-size:13px}
    .progress{height:10px;background:#0b1220;border:1px solid rgba(148,163,184,0.25);border-radius:999px;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#60a5fa,#3b82f6)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(148,163,184,0.15);text-align:left}
    th{color:#cbd5e1;font-weight:600}
    tr:hover td{background:rgba(2,6,23,0.2)}
    .emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:8px}
    .emoji{font-size:22px;line-height:40px;text-align:center;border:1px solid rgba(148,163,184,0.25);border-radius:12px;cursor:pointer;background:#0b1220}
    .emoji.selected{outline:2px solid #3b82f6}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#0b1220;border:1px solid rgba(148,163,184,0.25);font-size:12px}
    .section-title{font-size:16px;font-weight:700;margin:0 0 8px}
    .footer{margin-top:24px;color:#9ca3af;font-size:12px}
    .maplink{font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand"><div class="logo">KL</div><div>
        <div class="title">KonfiLog</div>
        <div class="muted">Gottesdienste und Kursbesuche verl√§sslich tracken</div>
      </div></div>
      <div id="userPill" class="pill hidden"></div>
    </header>

    <main class="grid">

      <!-- Links: Auth, Profil, Aktionen -->
      <section class="card">
        <h2 class="section-title">Anmeldung</h2>
        <div id="authBox">
          <div class="row">
            <input id="email" type="email" placeholder="E Mail" autocomplete="username" />
            <input id="password" type="password" placeholder="Passwort" autocomplete="current-password" />
          </div>
          <div class="row">
            <button id="loginBtn">Einloggen</button>
            <button id="registerBtn" class="secondary">Registrieren</button>
          </div>
          <p class="muted" style="margin:6px 0 0 0">Kein Passwort gesetzt oder vergessen? <button id="resetPwBtn" class="secondary" style="width:auto;padding:6px 10px">Passwort zur√ºcksetzen</button></p>
          <p class="muted">Mit der Registrierung stimmst du zu, dass Standortdaten beim Check in verarbeitet werden. Der Standort wird nur gespeichert, um den Besuch zu verifizieren.</p>
          <p id="authError" class="muted" style="margin-top:8px;color:#fca5a5"></p>
        </div>

        <div id="profileBox" class="hidden">
          <h3 class="section-title">Dein Profil</h3>
          <div class="row">
            <input id="firstName" placeholder="Vorname" />
            <input id="lastName" placeholder="Nachname" />
          </div>
          <div class="row">
            <select id="cohort">
              <option value="">Jahrgang w√§hlen</option>
              <option>2025</option>
              <option>2026</option>
              <option>2027</option>
            </select>
            <span class="badge" id="uidBadge"></span>
          </div>
          <div class="muted" style="margin:8px 0">Profilbild als Emoji w√§hlen</div>
          <div id="emojiGrid" class="emoji-grid"></div>
          <div class="row" style="margin-top:12px">
            <button id="saveProfile" class="good">Profil speichern</button>
            <button id="logoutBtn" class="secondary">Abmelden</button>
          </div>
        </div>

        <hr style="margin:18px 0;border:none;border-top:1px solid rgba(148,163,184,0.15)" />
        <div id="actionSection" class="hidden">
        <h3 class="section-title">Aktionen</h3>
        <div class="row">
          <button id="checkinServiceBtn">Gottesdienst besuchen</button>
          <button id="checkinCourseBtn" class="warn">Konfi Kurs besuchen</button>
        </div>
        <p id="actionMsg" class="muted" style="margin-top:10px"></p>
        </div>
      </section>

      <!-- Rechts: Fortschritt, letzte Eintr√§ge -->
      <section class="card">
        <h2 class="section-title">Dein Fortschritt</h2>
        <div style="display:grid;gap:12px">
          <div>
            <div class="row" style="align-items:center">
              <div>Gottesdienste</div>
              <div class="muted" id="svcCount">0 von 25</div>
            </div>
            <div class="progress"><div id="svcBar" class="bar" style="width:0%"></div></div>
          </div>
          <div>
            <div class="row" style="align-items:center">
              <div>Konfi Kurs</div>
              <div class="muted" id="crsCount">0 von 15</div>
            </div>
            <div class="progress"><div id="crsBar" class="bar" style="width:0%"></div></div>
          </div>
        </div>
        <h3 class="section-title" style="margin-top:16px">Letzte Aktivit√§ten</h3>
        <div id="recentList" class="muted">Noch keine Eintr√§ge</div>
      </section>

      <!-- Adminbereich -->
      <section class="card" id="adminBox" style="display:none">
        <h2 class="section-title">Adminbereich</h2>
        <p class="muted">Nur f√ºr berechtigte Personen. Sichtbar nach Admin Login.</p>
        <div class="row">
          <select id="adminCohort"><option value="">Jahrgang filtern</option></select>
          <button id="refreshAdmin" class="secondary">Aktualisieren</button>
        </div>
        <div style="overflow:auto;margin-top:12px">
          <table id="adminTable">
            <thead><tr><th>Name</th><th>Jahrgang</th><th>Gottesdienste</th><th>Kurs</th><th>Letzter Eintrag</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <h3 class="section-title" style="margin-top:18px">Kirchenorte verwalten</h3>
        <p class="muted">Ein Check in f√ºr Gottesdienste ist nur in Reichweite eines Kirchenorts m√∂glich.</p>
        <div class="row">
          <input id="churchName" placeholder="Name der Kirche" />
          <input id="churchLat" placeholder="Breite z. B. 51.199" />
          <input id="churchLng" placeholder="L√§nge z. B. 9.713" />
          <input id="churchRadius" placeholder="Radius in Metern z. B. 200" />
        </div>
        <div class="row" style="margin-top:8px">
          <button id="addChurchBtn" class="good">Kirche hinzuf√ºgen</button>
          <button id="listChurchesBtn" class="secondary">Kirchen anzeigen</button>
        </div>
        <div id="churchList" class="muted" style="margin-top:8px"></div>
      </section>

    </main>

    <footer class="footer">
      <div>Hinweis zum Datenschutz: Standortdaten werden bei einem Check in gespeichert. Sie dienen dem Nachweis des Kirchenbesuchs und werden nicht weitergegeben. Eine L√∂schung ist √ºber die Leitung m√∂glich.</div>
    </footer>
  </div>

  <!-- Firebase SDKs und App Logik als ES Module -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, getDocs, query, where, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // Firebase Konfiguration aus deinem Projekt
    const firebaseConfig = {
      apiKey: "AIzaSyDpNf0lFK1jv741mCx29Glri4p1ZC6wbvk",
      authDomain: "konfilog.firebaseapp.com",
      projectId: "konfilog",
      storageBucket: "konfilog.firebasestorage.app",
      messagingSenderId: "133206444282",
      appId: "1:133206444282:web:63b99320fd2663ef5a6143",
      measurementId: "G-YBD73Z4TZ1"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(_) {}
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Admin E Mails anpassen
    const ADMIN_EMAILS = ["dominik.teminski@ekkw.de"];

    // UI Elemente
    const authBox = document.getElementById('authBox');
    const profileBox = document.getElementById('profileBox');
    const adminBox = document.getElementById('adminBox');
    const userPill = document.getElementById('userPill');
    const uidBadge = document.getElementById('uidBadge');

    const emailEl = document.getElementById('email');
    const pwEl = document.getElementById('password');
    document.getElementById('loginBtn').onclick = () => login();
    document.getElementById('registerBtn').onclick = () => register();
    const resetPwBtn = document.getElementById('resetPwBtn');
    resetPwBtn.onclick = () => resetPw();
    document.getElementById('logoutBtn').onclick = () => signOut(auth);

    const firstName = document.getElementById('firstName');
    const lastName = document.getElementById('lastName');
    const cohort = document.getElementById('cohort');
    const emojiGrid = document.getElementById('emojiGrid');
    let selectedEmoji = 'üôÇ';

    const svcCount = document.getElementById('svcCount');
    const crsCount = document.getElementById('crsCount');
    const svcBar = document.getElementById('svcBar');
    const crsBar = document.getElementById('crsBar');
    const recentList = document.getElementById('recentList');

    const actionMsg = document.getElementById('actionMsg');
    const actionSection = document.getElementById('actionSection');
    const checkinServiceBtn = document.getElementById('checkinServiceBtn');
    const checkinCourseBtn = document.getElementById('checkinCourseBtn');

    const adminCohort = document.getElementById('adminCohort');
    const adminTableBody = document.querySelector('#adminTable tbody');
    document.getElementById('refreshAdmin').onclick = () => loadAdminOverview();

    document.getElementById('saveProfile').onclick = saveProfile;

    const addChurchBtn = document.getElementById('addChurchBtn');
    const listChurchesBtn = document.getElementById('listChurchesBtn');
    const churchList = document.getElementById('churchList');

    addChurchBtn.onclick = addChurch;
    listChurchesBtn.onclick = listChurches;

    checkinServiceBtn.onclick = () => guardedCheckin('service');
    checkinCourseBtn.onclick = () => guardedCheckin('course');

    // Emoji Auswahl
    const EMOJIS = [
      'üôÇ','üòä','üòé','ü§ì','ü§©','üòá','üò∫','ü¶ä','üêª','üêº','üê®','üêØ','üêµ','ü¶Å','ü¶Ñ','üê£',
      '‚öΩÔ∏è','üèÄ','üèà','üéæ','üéÆ','üéß','üé∏','üé§','üéπ','üé®','üìö','üß©','üö≤','üõº','üßë‚Äçüíª','üßë‚Äçüç≥'
    ];
    function renderEmojis(){
      emojiGrid.innerHTML = '';
      EMOJIS.forEach(e => {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'emoji' + (e===selectedEmoji ? ' selected' : '');
        b.textContent = e;
        b.onclick = () => { selectedEmoji = e; renderEmojis(); };
        emojiGrid.appendChild(b);
      });
    }
    renderEmojis();

    function mapAuthError(err){
      const c = err && err.code ? String(err.code) : '';
      if(c.includes('auth/network-request-failed')) return 'Netzwerkfehler. √ñffne die Seite √ºber HTTPS oder localhost.';
      if(c.includes('auth/invalid-email')) return 'Die E Mail Adresse ist ung√ºltig.';
      if(c.includes('auth/invalid-credential') || c.includes('auth/wrong-password')) return 'E Mail oder Passwort ist falsch.';
      if(c.includes('auth/user-not-found')) return 'Kein Konto gefunden. Bitte zuerst registrieren.';
      if(c.includes('auth/too-many-requests')) return 'Zu viele Versuche. Bitte warte kurz und versuche es erneut.';
      if(c.includes('auth/unauthorized-domain')) return 'Domain nicht autorisiert. Bitte github.io in Firebase freigeben.';
      return 'Fehler: ' + (err?.message || 'Unbekannt');
    }

    // Auth State
    onAuthStateChanged(auth, async (user) => {
      if(user){
        userPill.classList.remove('hidden');
        userPill.textContent = user.email;
        uidBadge.textContent = user.uid.slice(0,6) + '‚Ä¶';
        authBox.classList.add('hidden');
        profileBox.classList.remove('hidden');
        actionSection.classList.remove('hidden');

        const prof = await loadProfile(user.uid);
        if(prof){
          firstName.value = prof.firstName || '';
          lastName.value = prof.lastName || '';
          cohort.value = prof.cohort || '';
          selectedEmoji = prof.emoji || selectedEmoji;
          renderEmojis();
        }

        const isAdmin = ADMIN_EMAILS.includes(user.email?.toLowerCase());
        adminBox.style.display = isAdmin ? 'block' : 'none';
        if(isAdmin){
          fillCohortFilter();
          await ensureDefaultChurches();
          loadAdminOverview();
        }

        refreshProgress();
        listRecent();

      } else {
        userPill.classList.add('hidden');
        authBox.classList.remove('hidden');
        profileBox.classList.add('hidden');
        actionSection.classList.add('hidden');
        adminBox.style.display = 'none';
        recentList.textContent = 'Noch keine Eintr√§ge';
        setProgress(0,0);
      }
    });

    // Auth Funktionen
    async function resetPw(){
      const mail = emailEl.value.trim();
      if(!mail){ authError.textContent = 'Bitte E Mail f√ºr das Zur√ºcksetzen eintragen.'; return; }
      try{
        authError.textContent = '';
        await sendPasswordResetEmail(auth, mail);
        authError.style.color = '#86efac';
        authError.textContent = 'E Mail zum Zur√ºcksetzen wurde gesendet.';
        setTimeout(()=>{ authError.style.color = '#fca5a5'; }, 4000);
      } catch(e){
        authError.textContent = mapAuthError(e);
      }
    }

    async function login(){
      try{
        const mail = emailEl.value.trim();
        const pw = pwEl.value;
        if(!mail || !pw){ authError.textContent = 'Bitte E Mail und Passwort eintragen.'; return; }
        authError.textContent = '';
        await signInWithEmailAndPassword(auth, mail, pw);
      }catch(e){
        authError.textContent = mapAuthError(e);
      }
    }
    async function register(){
      try{
        const mail = emailEl.value.trim();
        const pw = pwEl.value;
        if(!mail || !pw){ authError.textContent = 'Bitte E Mail und ein neues Passwort eintragen.'; return; }
        if(pw.length < 6){ authError.textContent = 'Das Passwort muss mindestens 6 Zeichen haben.'; return; }
        authError.textContent = '';
        await createUserWithEmailAndPassword(auth, mail, pw);
      }catch(e){
        authError.textContent = mapAuthError(e);
      }
    }

    // Profil
    function userRef(uid){ return doc(db, 'users', uid); }

    async function loadProfile(uid){
      const d = await getDoc(userRef(uid));
      return d.exists() ? d.data() : null;
    }

    async function saveProfile(){
      const u = auth.currentUser;
      if(!u) return;
      const data = {
        firstName: firstName.value.trim(),
        lastName: lastName.value.trim(),
        cohort: cohort.value,
        emoji: selectedEmoji,
        updatedAt: serverTimestamp()
      };
      await setDoc(userRef(u.uid), data, {merge:true});
      alert('Profil gespeichert');
    }

    // Fortschritt
    async function refreshProgress(){
      const u = auth.currentUser; if(!u) return;
      const svcQ = query(collection(db,'checkins'), where('uid','==',u.uid), where('type','==','service'));
      const crsQ = query(collection(db,'checkins'), where('uid','==',u.uid), where('type','==','course'));
      const svcSnap = await getDocs(svcQ);
      const crsSnap = await getDocs(crsQ);
      setProgress(svcSnap.size, crsSnap.size);
    }
    function setProgress(svc, crs){
      const svcGoal = 25, crsGoal = 15;
      svcCount.textContent = `${svc} von ${svcGoal}`;
      crsCount.textContent = `${crs} von ${crsGoal}`;
      svcBar.style.width = Math.min(100, Math.round(svc*100/svcGoal)) + '%';
      crsBar.style.width = Math.min(100, Math.round(crs*100/crsGoal)) + '%';
    }

    async function listRecent(){
      const u = auth.currentUser; if(!u) return;
      const qy = query(
        collection(db,'checkins'),
        where('uid','==',u.uid),
        orderBy('ts','desc'),
        limit(10)
      );
      const qSnap = await getDocs(qy);
      if(qSnap.empty){ recentList.textContent = 'Noch keine Eintr√§ge'; return; }
      const rows = [];
      qSnap.forEach(docu => {
        const c = docu.data();
        const when = c.ts?.toDate ? c.ts.toDate().toLocaleString() : '';
        const place = c.placeName || `${Number(c.lat).toFixed(5)}, ${Number(c.lng).toFixed(5)}`;
        const link = `https://maps.google.com/?q=${c.lat},${c.lng}`;
        const typeTxt = c.type === 'service' ? 'Gottesdienst' : 'Konfi Kurs';
        rows.push(`<div style="margin:6px 0">${typeTxt} am ${when} in <a class=\"maplink\" href=\"${link}\" target=\"_blank\" rel=\"noopener\">${place}</a></div>`);
      });
      recentList.innerHTML = rows.join('');
    }

    // Check in Logik
    async function guardedCheckin(kind){
      const u = auth.currentUser; if(!u){ alert('Bitte einloggen'); return; }
      actionMsg.textContent = 'Hole Standort. Bitte Zustimmung erteilen.';
      navigator.geolocation.getCurrentPosition(async pos => {
        const {latitude: lat, longitude: lng} = pos.coords;
        try{
          if(kind === 'service'){
            const nearby = await nearestChurch(lat, lng);
            if(!nearby){
              actionMsg.textContent = 'Du bist nicht in Reichweite eines Kirchenorts. Kein Eintrag gespeichert.';
              return;
            }
            await saveCheckin({type:'service', lat, lng, placeName: nearby.name});
            actionMsg.textContent = `Gottesdienst erfasst in ${nearby.name}.`;
          } else {
            await saveCheckin({type:'course', lat, lng, placeName: 'Konfi Kurs'});
            actionMsg.textContent = 'Kursbesuch erfasst.';
          }
          await refreshProgress();
          await listRecent();
        }catch(e){
          actionMsg.textContent = 'Fehler beim Check in: ' + e.message;
        }
      }, err => {
        actionMsg.textContent = 'Standort nicht verf√ºgbar. Bitte Berechtigung pr√ºfen.';
      }, {enableHighAccuracy:true, timeout:15000});
    }

    async function saveCheckin({type, lat, lng, placeName}){
      const u = auth.currentUser; if(!u) return;
      await addDoc(collection(db,'checkins'), {
        uid: u.uid,
        type,
        lat, lng,
        placeName: placeName || null,
        ts: serverTimestamp()
      });
    }

    // Kirchenorte und Distanz
    function haversineMeters(lat1, lon1, lat2, lon2){
      const R = 6371000;
      const toRad = x => x*Math.PI/180;
      const dLat = toRad(lat2-lat1); const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }

    async function nearestChurch(lat, lng){
      const snap = await getDocs(collection(db,'churches'));
      let best = null; let bestDist = Infinity;
      snap.forEach(d => {
        const c = d.data();
        const dist = haversineMeters(lat, lng, c.lat, c.lng);
        if(dist < bestDist){ bestDist = dist; best = {...c, id:d.id, dist}; }
      });
      if(!best) return null;
      const within = best.dist <= (best.radiusMeters || 200);
      return within ? best : null;
    }

    // Admin √úbersicht
    async function fillCohortFilter(){
      adminCohort.innerHTML = '<option value="">Jahrgang filtern</option>';
      const seen = new Set();
      const users = await getDocs(collection(db,'users'));
      users.forEach(u => { const c = u.data().cohort; if(c && !seen.has(c)){ seen.add(c); const o=document.createElement('option'); o.value=c; o.textContent=c; adminCohort.appendChild(o);} });
    }

    async function loadAdminOverview(){
      adminTableBody.innerHTML = '<tr><td colspan="5" class="muted">Lade Daten ‚Ä¶</td></tr>';
      const usersSnap = await getDocs(collection(db,'users'));
      const cohortFilter = adminCohort.value;
      const rows = [];
      for(const u of usersSnap.docs){
        const data = u.data();
        if(cohortFilter && data.cohort !== cohortFilter) continue;
        const svc = await getDocs(query(collection(db,'checkins'), where('uid','==',u.id), where('type','==','service')));
        const crs = await getDocs(query(collection(db,'checkins'), where('uid','==',u.id), where('type','==','course')));
        let lastTs = null;
        [...svc.docs, ...crs.docs].forEach(d => { const t = d.data().ts; if(t && t.toDate && (!lastTs || t.toDate() > lastTs)) lastTs = t.toDate(); });
        const name = `${data.firstName || ''} ${data.lastName || ''}`.trim() || '(ohne Name)';
        rows.push(`<tr><td>${data.emoji || 'üôÇ'} ${name}</td><td>${data.cohort || ''}</td><td>${svc.size}</td><td>${crs.size}</td><td>${lastTs ? lastTs.toLocaleString() : ''}</td></tr>`);
      }
      adminTableBody.innerHTML = rows.join('') || '<tr><td colspan="5" class="muted">Keine Daten</td></tr>';
    }

    // Seed: Standardkirche einmalig anlegen
    async function ensureDefaultChurches(){
      const targetName = 'Ev. Stadtkirche Hessisch Lichtenau';
      const snap = await getDocs(collection(db,'churches'));
      let exists = false;
      snap.forEach(d => { if((d.data().name||'').toLowerCase() === targetName.toLowerCase()) exists = true; });
      if(!exists){
        await addDoc(collection(db,'churches'), { name: targetName, lat: 51.19780, lng: 9.70790, radiusMeters: 250 });
      }
    }

    // Admin Kirchenorte
    async function addChurch(){
      const name = document.getElementById('churchName').value.trim();
      const lat = parseFloat(document.getElementById('churchLat').value);
      const lng = parseFloat(document.getElementById('churchLng').value);
      const radius = parseInt(document.getElementById('churchRadius').value || '200', 10);
      if(!name || Number.isNaN(lat) || Number.isNaN(lng)) { alert('Bitte Name und Koordinaten angeben'); return; }
      await addDoc(collection(db,'churches'), {name, lat, lng, radiusMeters: radius});
      alert('Kirchenort gespeichert');
      listChurches();
    }

    async function listChurches(){
      const snap = await getDocs(collection(db,'churches'));
      if(snap.empty){ churchList.textContent = 'Noch keine Kirchen eingetragen'; return; }
      const arr = [];
      snap.forEach(d => { const c=d.data(); arr.push(`${c.name} ‚Ä¢ ${c.lat.toFixed(5)}, ${c.lng.toFixed(5)} ‚Ä¢ Radius ${c.radiusMeters || 200} m`); });
      churchList.textContent = arr.join('
');
    }
  </script>

  <!-- Optional: Reverse Geocoding √ºber Google Maps Geocoding API. API Key einsetzen. -->
  <script>
    // Wenn gew√ºnscht, kann beim Speichern des Check ins die Adresse ermittelt werden.
    // Dazu in saveCheckin vorher fetchGeocode(lat,lng) aufrufen und als placeName √ºbergeben.
    const GOOGLE_GEOCODE_API_KEY = ""; // optional einsetzen
    async function fetchGeocode(lat,lng){
      if(!GOOGLE_GEOCODE_API_KEY) return null;
      try{
        const r = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${GOOGLE_GEOCODE_API_KEY}`);
        const j = await r.json();
        return j.results?.[0]?.formatted_address || null;
      }catch{ return null; }
    }
  </script>

  <!--
    EMPFOHLENE FIREBASE SECURITY RULES (als Ausgangspunkt, in Firebase Console eintragen)

    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        function isSignedIn() { return request.auth != null; }
        function isAdmin() { return request.auth.token.email in ['pfarramt@example.org','selina@example.org']; }

        match /users/{uid} {
          allow read: if isSignedIn() && request.auth.uid == uid || isAdmin();
          allow write: if isSignedIn() && request.auth.uid == uid || isAdmin();
        }

        match /checkins/{id} {
          allow create: if isSignedIn() && request.resource.data.uid == request.auth.uid;
          allow read: if isSignedIn() && resource.data.uid == request.auth.uid || isAdmin();
          allow update, delete: if isAdmin();
        }

        match /churches/{id} {
          allow read: if isSignedIn();
          allow write: if isAdmin();
        }
      }
    }

    HINWEISE
    1. Diese Datei ist ein Single File Prototyp. F√ºr Produktion bitte Adminrechte mit Custom Claims steuern.
    2. Die Standortpr√ºfung f√ºr Gottesdienste nutzt eine Radiuspr√ºfung um einen Kirchenpunkt. Sie k√∂nnen mehrere Kirchen eintragen.
    3. Die Fortschrittsziele sind 25 Gottesdienste und 15 Kursabende. Werte lassen sich im Code anpassen.
    4. Die Oberfl√§che ist f√ºr Smartphones optimiert. Bitte als Vollbild Webseite bereitstellen.
  -->
</body>
</html>
